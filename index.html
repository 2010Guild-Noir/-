<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¿®ç¾…ç‹ä¸¸ã¨å¾€ãè™šã®ä»®æƒ³å¤œæ—…</title>

<link rel="icon" href="images/favicon.png" type="image/png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="images/favicon.svg" type="image/svg+xml">
<!-- äº’æ›ç”¨ã«PNGã‚‚ä½µè¨˜ -->
<link rel="icon" href="images/favicon-32.png" sizes="32x32" type="image/png">
<link rel="shortcut icon" href="favicon.ico">


<!-- Open Graph / Facebook / LINE / Slack ãªã© -->
<meta property="og:title" content="ä¿®ç¾…ç‹ä¸¸ã¨å¾€ãè™šã®ä»®æƒ³å¤œæ—…">
<meta property="og:description" content="5ã¤ã®é¸æŠã§é€²ã‚€è™šã‚ã®æ£®ã€‚ã©ã®é“ã«æ­£è§£ã‚‚å¤±æ•—ã‚‚ãªãã€ã‚ãªãŸã®æ­©ã¿ãŒå¤œã‚’ã‹ãŸã¡ä½œã‚‹ã€‚">
<meta property="og:type" content="website">
<meta property="og:url" content="https://2010guild-noir.github.io/-/">
<meta property="og:image" content="https://2010guild-noir.github.io/-/images/og.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitterï¼ˆXï¼‰ -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="ä¿®ç¾…ç‹ä¸¸ã¨å¾€ãè™šã®ä»®æƒ³å¤œæ—…">
<meta name="twitter:description" content="5ã¤ã®é¸æŠã§é€²ã‚€è™šã‚ã®æ£®ã€‚ã©ã®é“ã«æ­£è§£ã‚‚å¤±æ•—ã‚‚ãªãã€ã‚ãªãŸã®æ­©ã¿ãŒå¤œã‚’ã‹ãŸã¡ä½œã‚‹ã€‚">
<meta name="twitter:image" content="https://2010guild-noir.github.io/-/images/og.jpg">


<style>
  :root{
    --bg1:#0b1220;  /* å¤œç©ºã®ç¾¤é’ */
    --bg2:#1b2735;  /* æ£®ã®è— */
    --ink:#e9eef6;  /* æ–‡å­—è‰² */
    --mute:#8aa0b5; /* ã‚µãƒ–æ–‡å­— */
    --accent:#89b4fa; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
  }
  html,body{
    margin:0; padding:0; height:100%;
    background: radial-gradient(1200px 800px at 50% -10%, var(--bg2), var(--bg1));
    color:var(--ink); font-family: "Shippori Mincho", "æ¸¸æ˜æœ", "Yu Mincho", serif;
}
  .wrap{ max-width:900px; margin:0 auto; padding:24px 16px 56px; text-align:center; }
  h1{ margin:12px 0 6px; font-weight:700; font-size:clamp(20px, 3.6vw, 28px);}
  .sub{ color:var(--mute); margin:0 0 18px; font-size:14px;}
  .scene{
    width:min(92vw,880px); aspect-ratio: 16/9; object-fit: cover;
    border-radius:16px; box-shadow: 0 8px 28px rgba(0,0,0,.35); display:block; margin:8px auto 14px;
  }
  .panel{
    background: rgba(10,16,26,.45); backdrop-filter: blur(6px);
    border: 1px solid rgba(137,180,250,.18);
    border-radius: 16px; padding:18px 16px; margin:0 auto 14px; max-width:880px;
    box-shadow: 0 6px 24px rgba(0,0,0,.25);
    text-align:left;
  }
  .panel p{ margin: 0.4em 0; line-height:1.95; }
  .narr{ white-space:pre-wrap; }
  #micro{ margin: 2px 0 10px; color:#cfdbeb; }
  #text{ font-size:clamp(16px, 2.6vw, 20px); margin:0 0 10px; text-align:center;}
  .choices{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:12px 0 0;}
  button{
    background: transparent; color:var(--ink);
    border:1px solid var(--accent); border-radius:999px;
    padding:10px 18px; font-size:16px; cursor:pointer;
    transition:.15s transform ease, .15s background-color ease, .15s border-color ease;
  }
  button:hover{ transform: translateY(-1px); background: rgba(137,180,250,.08);}
  #story{ margin:16px 0 0; font-weight:600; min-height:2.6em; text-align:center;}
  #imageWrap img{ max-width:min(92vw,880px); height:auto; display:block; margin:14px auto 0; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.35);}
  .hint{ color:#8aa0b5; font-size:13px; margin-top:10px; text-align:center; }
  hr{ border:0; height:1px; background: linear-gradient(90deg,transparent, rgba(137,180,250,.35), transparent); margin:26px 0; }

  /* é€²æ—UI */
  .key{
    display:inline-block; margin:2px 4px; padding:2px 6px;
    border:1px solid rgba(137,180,250,.35); border-radius:8px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px; color:#cfe1ff;
  }
  .bar{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:1px; }

  /* BGM */
  .audioBar{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px auto 6px; opacity:.9; }
  .audioBar button{ border-radius:10px; padding:8px 12px; font-size:14px; }
  .audioBar input[type="range"]{ width:180px; }
  .badge{ display:inline-block; font-size:12px; color:#cfe1ff; border:1px dashed rgba(207,225,255,.5); padding:2px 8px; border-radius:8px; }
  .footnote{ color:var(--mute); font-size:12px; margin-top:8px; text-align:center;}

/* å³ä¸‹ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ */
#backBtn{
  position: fixed;
  right: 12px; bottom: 12px;
  font-size: 12px; line-height: 1;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(137,180,250,.35);
  background: rgba(10,16,26,.45);
  color: #cfe1ff;
  opacity: .55;
  backdrop-filter: blur(6px);
  box-shadow: 0 4px 14px rgba(0,0,0,.25);
  cursor: pointer;
  z-index: 50;
}
#backBtn:hover{ opacity: .85; transform: translateY(-1px); }
#backBtn:disabled{ opacity: .25; cursor: default; transform:none; }

</style>
</head>
<body>
<div class="wrap">
  <h1>ä¿®ç¾…ç‹ä¸¸ã¨å¾€ãè™šã®ä»®æƒ³å¤œæ—…</h1>
  <p class="sub">5ã¤ã®é¸æŠãŒè™šã‚ã®æ£®ã«é“ã‚’å¼•ãã€‚ã©ã®é“ã«æ­£è§£ã‚‚å¤±æ•—ã‚‚ãªãã€ãŸã èª°ã®ã‚‚ã®ã¨ã‚‚é•ã†ã€ã‚ãªãŸè‡ªèº«ã®æ—…ã¨ãªã‚‹ã€‚</p>

  <!-- å›ºå®šã®é¸æŠç”»é¢ç”»åƒï¼ˆä»»æ„ï¼‰ã€‚ç„¡ã‘ã‚Œã°è‡ªå‹•ã§éè¡¨ç¤ºã€‚ -->
  <img id="scene" class="scene" src="images/scene_select.webp" alt="å¤œã®æ£®" />

  <!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆå†’é ­ï¼‰ -->
 <div id="intro" class="panel">
  <p class="narr">ã—ã‚“ã—ã‚“ã¨ã€éŸ³ã‚‚ãªãå¤œãŒé™ã‚‹ã€‚</p>
  <p class="narr">ã‚ãªãŸã¯å¯åºŠã«èº«ã‚’ä¼¸ã°ã—ã€ãŸã ç›®ã‚’é–‰ã˜ã¦ã„ãŸã€‚</p>
  <p class="narr">ãã®ç„¡éŸ³ã«ã€ã²ã¨ã™ã˜ã®å£°ãŒå·®ã—è¾¼ã‚€ã€‚</p>
  <p class="narr">ã€Œå…¶æ–¹ã€è™šã‚ã®å¤œã‚’æ¸¡ã‚‹æ°—ã‹ã€</p>
  <p class="narr">é—‡ã‚’çºã£ãŸä¿®ç¾…ç‹ä¸¸ãŒ èµ¤ã„ç³ã§ã“ã¡ã‚‰ã‚’è¦‹ã¤ã‚ã¦ã„ã‚‹ã€‚</p>
  <p class="narr">æ°—ã¥ã‘ã°ã€ã‚ãªãŸã¯é»’ã„æ£®ã®ç¸ã«ç«‹ã£ã¦ã„ãŸã€‚</p>
  <p class="narr">ã€Œãªã‚‰ã°ã€ä½™ãŒå°ã“ã†ã€‚ãŸã ã—ã“ã‚Œã¯å¤¢ã§ã¯ãªã„ã€‚ä»®æƒ³ã«ã—ã¦ã€çœŸã®æ—…ã‚ˆã€</p>
</div>

  <!-- é¸æŠãƒ‘ãƒãƒ« -->
  <div class="panel">
    <p id="micro" class="narr"></p>
    <p id="text" style="text-align:center;">å¤œã®æ£®ã§ã€ä¿®ç¾…ç‹ä¸¸ãŒæ‰‹æ‹›ãã€‚ã‚ãªãŸã¯æ­©ã‚’åˆã‚ã›ã‚‹ï¼Ÿ</p>
    <div id="choices" class="choices" style="text-align:center;">
      <button onclick="choose(1)">æ­©ã‚’åˆã‚ã›ã‚‹</button>
      <button onclick="choose(2)">è·é›¢ã‚’å–ã‚‹</button>
    </div>
    <p id="story"></p>
  </div>

  <div id="imageWrap"></div>
  <div id="endControls" style="text-align:center; margin-top:10px;"></div>

  <p class="hint" id="hint"></p>
  <p class="hint" id="progress"></p>
  <details id="comp" class="hint" style="margin-top:6px;">
    <summary>æœªé”ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ä¸€è¦§ã‚’é–‹ã</summary>
    <div id="unseen" class="hint" style="margin-top:8px;"></div>
  </details>


  <!-- ===== BGMï¼ˆãƒšãƒ¼ã‚¸æœ€ä¸‹éƒ¨ï¼‰ ===== -->
  <div class="panel" style="text-align:center; margin-top:24px;">
    <p class="narr" style="text-align:center; color:#cfdbeb; margin-bottom:10px;">å¤œæ­©ãã®æ”¯åº¦ï¼šéŸ³ãŒé‚ªé­”ãªã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆã‚’ã€‚å°ã•ãæµã™ã®ã‚‚ä¸€èˆˆã ã€‚</p>
    <audio id="bgm" src="audio/bgm_night_forest.mp3" loop preload="auto"></audio>
    <div class="audioBar">
      <span class="badge">BGM</span>
      <button id="playBtn" onclick="togglePlay()">â–¶ å†ç”Ÿ</button>
      <button onclick="bgm.muted = !bgm.muted; this.textContent = bgm.muted ? 'ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤' : 'ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ';">ğŸ”Š ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
      <label>éŸ³é‡ <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35" oninput="bgm.volume=this.value"></label>
    </div>
    <p class="footnote">â€» è‡ªå‹•å†ç”Ÿåˆ¶é™ã«ã‚ˆã‚Šã€æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯ã¾ã§éŸ³ã¯é³´ã‚Šã¾ã›ã‚“ã€‚</p>
  </div>
</div>
<!-- â–¼ ã“ã“ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  â–¼ -->
  <button id="backBtn" onclick="goBack()" title="ä¸€æ‰‹æˆ»ã‚‹">â† æˆ»ã‚‹</button>
  <!-- â–² è¿½åŠ ã“ã“ã¾ã§ â–² -->
<script>
  /* ===== åŸºæœ¬è¨­å®š ===== */
  const DEPTH = 5;            // 5æ®µéš = 32ã‚¨ãƒ³ãƒ‰
  let step = 0;               // ç¾åœ¨æ®µéšï¼ˆ0ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
  let path = [];              // é¸æŠã®è¨˜éŒ² [1,2,1,2,1]
  const introEl  = document.getElementById("intro");
  const microEl  = document.getElementById("micro");
  const textEl   = document.getElementById("text");
  const storyEl  = document.getElementById("story");
  const choicesEl= document.getElementById("choices");
  const hintEl   = document.getElementById("hint");
  const imageWrap= document.getElementById("imageWrap");
  const sceneImg = document.getElementById("scene");
  sceneImg.onerror = ()=>{ sceneImg.style.display = "none"; };

  // BGM
  const bgm = document.getElementById("bgm");
  const playBtn = document.getElementById("playBtn");
  bgm.volume = 0.35;
  let audioArmed = false;
  function armAudio(){ if(!audioArmed){ audioArmed = true; bgm.play().catch(()=>{}); updatePlayBtn(); } }
  function togglePlay(){ if(bgm.paused){ bgm.play().catch(()=>{}); } else { bgm.pause(); } updatePlayBtn(); }
  function updatePlayBtn(){ playBtn.textContent = bgm.paused ? "â–¶ å†ç”Ÿ" : "â¸ ä¸€æ™‚åœæ­¢"; }
  document.addEventListener("click", armAudio, { once:true });
  bgm.addEventListener("play", updatePlayBtn);
  bgm.addEventListener("pause", updatePlayBtn);

  /* ===== å„æ®µã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ ===== */
  function getNarr(step, prefix){
 const N = {
  2: {
    "A":
`è½ã¡è‘‰ãŒã‚„ã‚ã‚‰ã‹ãé³´ã‚‹ã€‚ã‚ãªãŸãŒä¸€æ­©é€²ã‚€ãŸã³ã€è¶³éŸ³ã¯å¤œã«å¸ã‚ã‚Œã‚‹ã€‚
ã€Œè¶³ã‚’åˆã‚ã›ã‚‹å¿…è¦ã¯ãªã„ã€‚å‘¼å¸ã‚’åˆã‚ã›ã‚ˆã€‚é™ã‘ã•ã¯å‘³æ–¹ã ã€`,
    "B":
`å°‘ã—é›¢ã‚Œã‚‹ã¨ã€æ£®ã®è¼ªéƒ­ãŒåºƒãè¦‹ãˆã‚‹ã€‚è·é›¢ã¯å®‰å¿ƒã«ã‚‚è¿·ã„ã«ã‚‚ãªã‚‹ã€‚
ã€Œé›¢ã‚Œã‚‹ã®ã¯è‰¯ã„ã€‚ãŸã ã—è¦‹å¤±ã†ã»ã©é ã–ã‹ã‚‹ãªã€‚è‡ªåˆ†ã®æ­©å¹…ã‚’å¿˜ã‚Œã‚‹ãªã€`
  },
  3: {
    "AA":
`æœ¨ç«‹ã®å¥¥ã«å°ã•ãªç¥ ã€‚æˆ¸ã¯å¤ãã€æŠ¼ã›ã°é–‹ããã†ã ã€‚
ã€Œæ‰‰ã¯èªã‚‰ã¬ã€‚é–‹ã‘ã°æ²ˆé»™ã§ç­”ãˆã‚‹ã€‚å…¥ã‚‹ã‹ã€ç•™ã‚ã‚‹ã‹ã€é¸ã¹ã€`,
    "AB":
`è‰ã‚€ã‚‰ã§éœ²ãŒæºã‚Œã€é‡‘å±ã®ã‚ˆã†ãªæ¾„ã‚“ã éŸ³ãŒã‹ã™ã‹ã«éŸ¿ãã€‚
ã€Œè§¦ã‚Œã¦ç¢ºã‹ã‚ã‚‹ã‚‚ã€ãã£ã¨è¦‹é€ã‚‹ã‚‚ã€ã©ã¡ã‚‰ã‚‚é™ã‘ã•ã®ä½œæ³•ã ã€`,
    "BA":
`ç´°ã„å·ãŒé“ã‚’æ¨ªåˆ‡ã‚‹ã€‚æµã‚Œã¯æµ…ã„ãŒã€è¶³ã‚’æ¿¡ã‚‰ã›ã°å†·ãŸã„ã€‚
ã€Œæ¸¡ã‚‹ã¯æ±ºæ„ã€æ¸¡ã‚‰ã¬ã¯è¦‹æ¥µã‚ã€‚ã©ã¡ã‚‰ã‚‚è¡“ã ã€‚å·±ã«åˆã†æ–¹ã‚’å–ã‚Œã€`,
    "BB":
`ç£é“ãŒå·¦å³ã«åˆ†ã‹ã‚Œã‚‹ã€‚ã©ã¡ã‚‰ã«ã‚‚è¸ã¿è·¡ã¯ã‚ã‚‹ãŒã€å…ˆã¯è¦‹ãˆãªã„ã€‚
ã€Œåœ°å›³ã¯ãªã„ã€‚ã‚ã‚‹ã®ã¯å…¶æ–¹ã®åˆ¤æ–­ã ã‘ã€‚æ±ºã‚ã‚ˆã€`
  },
  4: {
    "AAA":
`ç¥ ã®å¥¥ã«ç¯ãŒä¸€ã¤ã€å¼±ãæºã‚Œã‚‹ã€‚æ¯ã‚’å¹ãã‹ã‘ã‚Œã°å¼·ã¾ã‚Šã‚‚æ¶ˆãˆã‚‚ã™ã‚‹ã€‚
ã€Œç¯ã‚’æ‰±ãˆã€‚ç¯ã«æŒ¯ã‚Šå›ã•ã‚Œã‚‹ãªã€‚ã¨ã‚‚ã™ã‹ã€æ¶ˆã™ã‹ã€`,
    "AAB":
`åã‚’å‘¼ã‚“ã ä½™éŸ»ãŒã¾ã æ®‹ã‚‹ã€‚ã‚‚ã†ä¸€åº¦å‘¼ã¹ã°ã€ã•ã‚‰ã«æ·±ãå±Šãã ã‚ã†ã€‚
ã€ŒäºŒåº¦ç›®ã¯æƒ…ã§ãªãæŠ€ã§å‘¼ã¹ã€‚å‘¼ã¶ã‹ã€æ­¢ã‚ã‚‹ã‹ã€`,
    "ABA":
`æ¡ã£ãŸæ‰‹ã®æ¸©åº¦ãŒç¾ã¸å¼•ãæˆ»ã™ã€‚å¼·ãæ¡ã‚Œã°ç¢ºã‹ã€é›¢ã›ã°æ­©ãã‚„ã™ã„ã€‚
ã€Œæ¡ã‚‹ã¯æ”¯ãˆã€é›¢ã™ã¯å§”ã­ã€‚ã©ã¡ã‚‰ã‚’é¸ã¶ã€`,
    "ABB":
`èƒŒä¸­ã«æ®‹ã‚‹æ¸©ã‚‚ã‚ŠãŒè–„ã‚Œã¦ã„ãã€‚æŒ¯ã‚Šè¿”ã‚Œã°æ‹¾ãˆã‚‹ãŒã€æ­©ã¯æ­¢ã¾ã‚‹ã€‚
ã€Œå›åã™ã‚‹ã‹ã€å‰ã¸è­²ã‚‹ã‹ã€‚åˆ¥ã‚Œã®ç¤¼æ³•ã‚’é¸ã¹ã€`,
    "BAA":
`å·å¹…ã¯ç‹­ã„ã€‚æµ…ç€¬ã«å¹³ãŸã„çŸ³ãŒç‚¹ã€…ã¨ç¶šãã€‚è¶³ã‚’å…¥ã‚Œã‚Œã°é€Ÿã„ãŒå†·ãŸã„ã€‚
ã€Œæ¿¡ã‚Œã‚‹é€Ÿã•ã‹ã€ç¢ºã‹ãªè¶³å ´ã‹ã€‚å…¶æ–¹ã¯ã©ã¡ã‚‰ã‚’è©¦ã™ï¼Ÿã€`,
    "BAB":
`æ©‹ã¯ãªã„ãŒå£°ã¯æ¸¡ã‚‹ã€‚çŸ­ã„è¨€è‘‰ãªã‚‰ã€æµã‚Œã«å‘‘ã¾ã‚Œãšå±Šãã€‚
ã€Œå£°ã‚’ã‹ã‘ã‚‹ã‹ã€é»™ã£ã¦ã†ãªãšãã‹ã€‚ã©ã¡ã‚‰ã‚‚æ„æ€ã ã€`,
    "BBA":
`å·¦ã®é“ã¯æ¹¿ã£ã¦æ»‘ã‚Šã‚„ã™ã„ãŒã€è‰ãŒæŸ”ã‚‰ã‹ã„ã€‚å³ã¯ä¹¾ã„ã¦é€Ÿã„ãŒã€çŸ³ãŒå°–ã‚‹ã€‚
ã€Œé…ãæ…é‡ã«ã‹ã€é€Ÿãè»½ã‚„ã‹ã«ã‹ã€‚ä»Šã®å…¶æ–¹ã«æ­£ã—ã„æ–¹ã‚’é¸ã¹ã€`,
    "BBB":
`å‰ã¯è¡Œãæ­¢ã¾ã‚Šã«è¦‹ãˆã‚‹ã€‚ã ãŒç©ºã¯é–‹ãã€åœ°é¢ã«ã¯ç´°ã„æ®µå·®ãŒç¶šãã€‚
ã€Œåã‚’å¤‰ãˆã‚Œã°é“ã«ãªã‚‹ã€‚ç©ºã‚’è¦‹ã‚‹ã‹ã€è¶³å…ƒã‚’è¦‹ã‚‹ã‹ã€‚é¸ã¹ã€`
  }
};


    // 2ã€œ4æ®µç›®ï¼šæœ€é•·ä¸€è‡´ã§è¿”ã™
    const m = N[step];
    if (m){
      let key = prefix || "";
      while(key.length >= 0){
        if(m[key]) return m[key];
        key = key.slice(0,-1);
        if(key.length===0) break;
      }
    }

    // 5æ®µç›®ï¼šä¿®ç¾…ç‹ä¸¸ã®ä¸€è¨€ï¼ˆæœ€çµ‚ã®å‰å£ä¸Šï¼‰
   if (step === 5){
  const last2 = (prefix || "").slice(-2);
  const narrMap = {
    "AA": "ã€Œè¿‘ã•ã¯åŠ›ã«ã‚‚åˆƒã«ã‚‚ãªã‚‹ã€‚æœ€å¾Œã®ä¸€æ‰‹ã€è½ã¡ç€ã„ã¦é¸ã¹ã€",
    "AB": "ã€Œé–“åˆã„ã¯æ•´ã£ãŸã€‚å´©ã™ã‚‚å®ˆã‚‹ã‚‚ã€ã“ã“ã§æ±ºã‚ã‚ˆã€",
    "BA": "ã€ŒéŸ³ã¯ç´°ã‚Šã€é“ã¯ç—©ã›ãŸã€‚æ¸¡ã‚Šãã‚‹ã‹ã€ç•™ã¾ã‚‹ã‹ã€‚ã©ã¡ã‚‰ã‚‚æ­£ã ã€",
    "BB": "ã€Œé¢¨ãŒé–‹ã‘ãŸã€‚ä»°ãç©ºã¨è¸ã‚€åœ°ã€ä»Šã®å…¶æ–¹ã¯ã©ã¡ã‚‰ã‚’è¦‹ã‚‹ã€"
  };
  return narrMap[last2] || "ã€Œæ£®ã¯æ¯ã‚’æ½œã‚ãŸã€‚å…¶æ–¹ã®ä¸€æ‰‹ã§æ—…ã‚’ç· ã‚ã‚ˆã€";
}


    return "";
  }

  /* ===== ä¸­é–“ãƒãƒ¼ãƒ‰ï¼ˆå•ã„ã¨ãƒœã‚¿ãƒ³æ–‡ï¼‰ ===== */
  function getNode(step, prefix){
    const T = {
  1: {
    "": { q:"å¤œã®æ£®ã§ã€ä¿®ç¾…ç‹ä¸¸ãŒæ‰‹æ‹›ãã€‚ã‚ãªãŸã¯æ­©ã‚’åˆã‚ã›ã‚‹ï¼Ÿ",
          a:"æ­©ã‚’åˆã‚ã›ã‚‹", b:"è·é›¢ã‚’å–ã‚‹" }
  },
  2: {
    "A": { q:"å‘¼å¸ã‚’æ•´ãˆãªãŒã‚‰é€²ã‚€ã€‚æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ",
           a:"åã‚’å‘¼ã¶", b:"é»™ã£ã¦ä¸¦ã¶" },
    "B": { q:"è·é›¢ã‚’ä¿ã£ãŸã¾ã¾é€²ã‚€ã€‚æ¬¡ã¯ã©ã†ã™ã‚‹ï¼Ÿ",
           a:"è¿½ã„ã¤ã", b:"ã•ã‚‰ã«é›¢ã‚Œã‚‹" }
  },
  3: {
    "AA":{ q:"å°ã•ãªç¥ ã®å‰ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
           a:"æ‰‰ã‚’æŠ¼ã—é–‹ã‘ã‚‹", b:"æ‰‹ã‚’ç½®ã„ã¦æ°—é…ã‚’èª­ã‚€" },
    "AB":{ q:"éœ²ã®éŸ³ãŒé³´ã‚‹è‰ã‚€ã‚‰ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
           a:"æ‰‹ã‚’ä¼¸ã°ã—ã¦ç¢ºã‹ã‚ã‚‹", b:"æ‰‹ã‚’å¼•ã„ã¦è¦‹å®ˆã‚‹" },
    "BA":{ q:"æµ…ã„æµã‚ŒãŒé“ã‚’æ–­ã¤ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
           a:"æ¸¡ã‚‹", b:"æ¸¡ã‚‰ãªã„" },
    "BB":{ q:"åˆ†ã‹ã‚Œé“ã€‚ã©ã¡ã‚‰ã¸ï¼Ÿ",
           a:"å·¦ã¸é€²ã‚€", b:"å³ã¸é€²ã‚€" }
  },
  4: {
    "AAA":{ q:"å¼±ã„ç¯ã€‚ã©ã†æ‰±ã†ï¼Ÿ",
            a:"ç¯ã‚’ã¨ã‚‚ã™", b:"ç¯ã‚’æ¶ˆã™" },
    "AAB":{ q:"åã®ä½™éŸ»ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
            a:"ã‚‚ã†ä¸€åº¦å‘¼ã¶", b:"å‘¼ã¶ã®ã‚’ã‚„ã‚ã‚‹" },
    "ABA":{ q:"æ‰‹ã®ã¬ãã‚‚ã‚Šã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
            a:"æ‰‹ã‚’æ¡ã‚‹", b:"æ‰‹ã‚’é›¢ã™" },
    "ABB":{ q:"èƒŒã®æ¸©åº¦ãŒè–„ã‚Œã‚‹ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
            a:"æŒ¯ã‚Šè¿”ã‚‹", b:"ãã®ã¾ã¾æ­©ã" },
    "BAA":{ q:"æµ…ç€¬ã¨é£›ã³çŸ³ã€‚ã©ã†é€²ã‚€ï¼Ÿ",
            a:"æ°´ã‚’è¸ã‚“ã§é€Ÿãé€²ã‚€", b:"çŸ³ã‚’é¸ã‚“ã§ç¢ºã‹ã«é€²ã‚€" },
    "BAB":{ q:"å£°ã¯å±Šãè·é›¢ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
            a:"å£°ã‚’ã‹ã‘ã‚‹", b:"é»™ã£ã¦ã†ãªãšã" },
    "BBA":{ q:"æ¹¿ã‚Šã®é“ã¨ä¹¾ãã®é“ã€‚ã©ã¡ã‚‰ã¸ï¼Ÿ",
            a:"æ¹¿ã£ãŸé“", b:"ä¹¾ã„ãŸé“" },
    "BBB":{ q:"è¡Œãæ­¢ã¾ã‚Šã«è¦‹ãˆã‚‹å‰æ–¹ã€‚ã©ã†ã™ã‚‹ï¼Ÿ",
            a:"ç©ºã‚’ä»°ã", b:"è¶³å…ƒã‚’è¦‹ã‚‹" }
  }
};


    // 1ã€œ4æ®µç›®ï¼šæœ€é•·ä¸€è‡´
    if (step >= 1 && step <= 4) {
      const s = T[step]; if (!s) return { q:"æ£®ã¯é™ã‹ã«ã‚ãªãŸã‚’å¾…ã¤ã€‚ã©ã†ã™ã‚‹ï¼Ÿ", a:"é€²ã‚€", b:"ç•™ã¾ã‚‹" };
      let key = prefix || "";
      while (key.length >= 0) {
        if (s[key]) return s[key];
        key = key.slice(0, -1);
        if (key.length === 0 && s[""]) return s[""];
        if (key.length === 0) break;
      }
      return { q:"æ£®ã¯é™ã‹ã«ã‚ãªãŸã‚’å¾…ã¤ã€‚ã©ã†ã™ã‚‹ï¼Ÿ", a:"é€²ã‚€", b:"ç•™ã¾ã‚‹" };
    }

    // 5æ®µç›®ã¯å‹•çš„ã«ç”Ÿæˆï¼ˆprefix ã¯4æ–‡å­—ï¼ç›´å‰ã¾ã§ã®çµŒè·¯ï¼‰
    if (step === 5) {
      const last2 = (prefix || "").slice(-2); // "AA","AB","BA","BB"
      const map = {
        "AA": { q:"æœ€å¥¥ã€‚ç¯ã¨å½±ãŒå¯„ã‚Šæ·»ã†ã€‚ã‚ãªãŸã®æœ€å¾Œã®é¸æŠã¯ï¼Ÿ",
                a:"ãã°ã«å¯„ã‚‹", b:"èº«ã‚’é€€ã" },
        "AB": { q:"æœã¨å¤œã®é™ã‹ãªé–“åˆã„ãŒå‡ªãã€‚ã‚ãªãŸã®æœ€å¾Œã®é¸æŠã¯ï¼Ÿ",
                a:"æšã‚’ç›®æŒ‡ã™", b:"æ£®ã¸å¼•ãè¿”ã™" },
        "BA": { q:"æœ€å¥¥ã€‚å·éŸ³ãŒç´°ã‚Šé“ãŒç—©ã›ã‚‹ã€‚ã‚ãªãŸã®æœ€å¾Œã®é¸æŠã¯ï¼Ÿ",
                a:"æ¸¡ã‚Šãã‚‹", b:"å²¸ã«ç•™ã¾ã‚‹" },
        "BB": { q:"æœ€å¥¥ã€‚é¢¨ãŒé–‹ã‘ã‚‹ã€‚ã‚ãªãŸã®æœ€å¾Œã®é¸æŠã¯ï¼Ÿ",
                a:"ç©ºã‚’ä»°ã", b:"åœ°ã‚’è¸ã¿ã—ã‚ã‚‹" }
      };
      return map[last2] || { q:"æœ€å¥¥ã€‚æ£®ã¯æ¯ã‚’æ½œã‚ã‚‹ã€‚ã‚ãªãŸã¯ï¼Ÿ", a:"é€²ã¿å‡ºã‚‹", b:"ç«‹ã¡æ­¢ã¾ã‚‹" };
    }

    return { q:"æ£®ã¯é™ã‹ã«ã‚ãªãŸã‚’å¾…ã¤ã€‚ã©ã†ã™ã‚‹ï¼Ÿ", a:"é€²ã‚€", b:"ç•™ã¾ã‚‹" };
  }


/* ===== ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ–‡ç”Ÿæˆ ===== */
function composeEnding(key){
  const Acount = [...key].filter(c => c === "A").length;     // Aã®æ•°ï¼ˆ0..5ï¼‰
  const last   = key[key.length - 1];                        // æœ€å¾Œã®æ‰‹ A/B
  const first2 = key.slice(0,2);                             // å†’é ­å‚¾å‘
  const last2  = key.slice(-2);                              // çµ‚ç›¤å‚¾å‘

  // çµŒè·¯ã‚­ãƒ¼ã‚’ 0..31 ã®æ•´æ•°ã«ï¼ˆA=0, B=1 ã®2é€²æ•°ï¼‰
  const pathNum = parseInt(key.replace(/A/g, '0').replace(/B/g, '1'), 2);
  const pick5 = n => ((n % 5) + 5) % 5;                      // å®‰å…¨ãª mod 5
  const idx = pick5(pathNum);

  // å†’é ­æƒ…æ™¯ï¼ˆå‰åŠ2æ‰‹ã§æ±ºå®šï¼‰
  const motif1 = ({
    "AA": "æœˆæ˜ã‹ã‚ŠãŒäºŒäººã®å½±ã‚’é™ã‹ã«è½ã¨ã—ã€",
    "AB": "éœ²ãŒé¢¨ã«éœ‡ãˆã€è‰ã‚€ã‚‰ã®éˆ´ãŒé ãã§é³´ã‚Šã€",
    "BA": "å·éŸ³ãŒç´°ããªã‚Šã€æµ…ã„æ³¢ç´‹ãŒé´å…ˆã‚’æ’«ã§ã€",
    "BB": "æè‘‰ã®éš™é–“ã‹ã‚‰æ˜ŸãŒã“ã¼ã‚Œã€"
  })[first2] || "å¤œãŒæ·±ã•ã‚’å¢—ã—ã€";

  // çµ‚ç›¤æƒ…æ™¯ï¼ˆçµ‚ç›¤2æ‰‹ã§æ±ºå®šï¼‰
  const motif2 = ({
    "AA": "ç¥ ã®ç¯ãŒæ¯ã®ã‚ˆã†ã«æ˜æ»…ã—ã€",
    "AB": "é–“åˆã„ã¯å‡ªã„ã§é™ã‘ã•ãŒæ·±ã¾ã‚Šã€",
    "BA": "å²¸ã®åŒ‚ã„ãŒè¿‘ã¥ã„ã¦é“ã¯ç—©ã›ã€",
    "BB": "é¢¨ã¯é“ã‚’é–‹ãåœ°ã¯ç¢ºã‹ã•ã‚’è¿”ã—ã€"
  })[last2] || "æ£®ã¯æ¯ã‚’æ½œã‚ã€";

  // æœ€å¾Œã®ä¸€æ­©ï¼ˆç›´è¿‘ã®A/Bã§æ±ºå®šï¼‰
  const hinge = (last === "A")
    ? "æœ€å¾Œã®ä¸€æ­©ã¯å…¶æ–¹ãŒå…ˆã«è¸ã¿å‡ºã—ã€"
    : "æœ€å¾Œã®ä¸€æ­©ã¯ä½™ãŒå…ˆã«è¸ã¿ã€å…¶æ–¹ã¯å¢ƒã®æ‰‹å‰ã«ç«‹ã¡ã€";

  // æœ¬æ–‡ç· ã‚ï¼ˆAå¤š/Bå¤š ãã‚Œãã‚Œ5ç¨®ï¼‰
  const farewellA = [
    "ã ã‹ã‚‰ã“ãå…¶æ–¹ã®æ­©ã¿ã¯å°Šã„ã€‚",
    "ãã®æƒ³ã„ã¯å—ã‘å–ã£ãŸã€‚",
    "ã“ã®å…ˆã¯ã€å…¶æ–¹ã¯å…¶æ–¹ã®é€Ÿã•ã§è¡Œã‘ã€‚",
    "ãã®é¸æŠã‚’ä½™ã¯å¬‰ã—ãæ€ã†ã€‚",
    "ã“ã®å…ˆã¯åæ®‹ã¯æ®‹ã‚‹ãŒã€é“ã¯åˆ¥ã ã€‚"
  ];
  const farewellB = [
    "ã‚ˆãæ­©ã„ãŸãªã€‚",
    "ã“ã“ã‹ã‚‰ã¯å…¶æ–¹ã®é“ã ã€‚",
    "æ—…ã®ç¶šãã‚’è´ˆã‚ã†ã€‚",
    "å…ˆã®é“ã¯äºŒã¤ã«åˆ†ã‹ã‚ŒãŸã€‚",
    "æŒ¯ã‚Šè¿”ã‚‰ãšé€²ã‚ã€‚"
  ];
  const isAheavy = (Acount >= 3);
  const farewellBody = (isAheavy ? farewellA : farewellB)[idx];

  // â˜… ä¿®ç¾…ç‹ä¸¸ã®æœ€å¾Œã®ä¸€è¨€ã¯å‰Šé™¤ï¼ˆã“ã“ãŒãªããªã£ã¦ã„ã¾ã™ï¼‰
  return `${motif1}${motif2}${hinge}${farewellBody}`;
}

  /* ===== é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ===== */
  function pathToKey(arr){ return arr.map(n => n===1 ? "A" : "B").join(""); }

  function renderNext(){
    const prefix   = pathToKey(path);
    const nextStep = step + 1;

    // 2æ®µç›®ä»¥é™ã®å‰å£ä¸Šï¼ˆ5æ®µç›®ã‚‚å«ã‚€ï¼‰
    microEl.innerText = (nextStep >= 2) ? getNarr(nextStep, prefix) : "";

    const node = getNode(nextStep, prefix);

    textEl.innerText = node.q;
    storyEl.innerText = "";
    imageWrap.innerHTML = "";
    hintEl.innerText = `é¸æŠ ${step}/${DEPTH}ï¼ˆçµŒè·¯: ${prefix || "â€”"}ï¼‰`;

    choicesEl.innerHTML =
      `<button onclick="choose(1)">${escapeHtml(node.a)}</button>` +
      `<button onclick="choose(2)">${escapeHtml(node.b)}</button>`;
  // â–¼ ã“ã“ã‚’è¿½åŠ 
  updateBackBtn();
  // â–² ã“ã“ã¾ã§
}

  function choose(option){
    armAudio();
    if(step === 0 && introEl) introEl.style.display = "none";

    path.push(option);
    step++;

    if(step < DEPTH){
      renderNext();
      return;
    }

    // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
    const key = pathToKey(path);
    const text = composeEnding(key);

    // é”æˆç‡ï¼šè¨˜éŒ²ï¼†æ›´æ–°
    window.__shuraVisited.add(key);
    if(window.__saveVisited) window.__saveVisited();
    if(window.__updateProgress) window.__updateProgress();
    if(window.__renderUnseen) window.__renderUnseen();

    microEl.innerText = "";
    textEl.innerText = "ã€æ—…ã®çµæœ«ã€‘ï¼ˆ" + key + "ï¼‰";
    storyEl.innerText = text;

    // ãƒ‘ãƒãƒ«å†…ã¯ç©ºã«ã—ã€ç”»åƒã®ä¸‹ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å‡ºã™
    hintEl.innerText ="";
    choicesEl.innerHTML = "";

    renderEndingImage(key);
    const endControls = document.getElementById("endControls");
    endControls.innerHTML =
      '<button onclick="restart()">æœ€åˆã‹ã‚‰</button>' +
      '<p class="hint" style="margin-top:8px;">ã‚‚ã†ä¸€åº¦éŠã¶ã«ã¯ã€Œæœ€åˆã‹ã‚‰ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>';

    sceneImg.style.display = "none";
// â–¼ ã“ã“ã‚’è¿½åŠ ï¼ˆã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’éš ã™ï¼‰
    updateBackBtn();
    // â–² ã“ã“ã¾ã§
  }

  function renderEndingImage(key){
    const imgPath = "images/ending_" + key + ".webp";
    const img = new Image();
    img.alt = "Ending " + key;
    img.onload = ()=>{ imageWrap.innerHTML=""; imageWrap.appendChild(img); };
    img.onerror = ()=>{ imageWrap.innerHTML=""; };
    img.src = imgPath;
  }

  function restart(){
    step = 0; path = [];
    if(introEl) introEl.style.display = "";
    microEl.innerText = "";
    textEl.innerText = "å¤œã®æ£®ã§ã€ä¿®ç¾…ç‹ä¸¸ãŒæ‰‹æ‹›ãã€‚ã‚ãªãŸã¯æ­©ã‚’åˆã‚ã›ã‚‹ï¼Ÿ";
    storyEl.innerText = ""; hintEl.innerText = "";
    choicesEl.innerHTML =
      '<button onclick="choose(1)">æ­©ã‚’åˆã‚ã›ã‚‹</button>' +
      '<button onclick="choose(2)">è·é›¢ã‚’å–ã‚‹</button>';
    imageWrap.innerHTML = "";
    sceneImg.style.display = "";
    document.getElementById("endControls").innerHTML = "";
// â–¼ ã“ã“ã‚’è¿½åŠ 
  updateBackBtn();
  // â–² ã“ã“ã¾ã§
  }

/* â”€â”€ æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ï¼ˆã“ã“ã‹ã‚‰è¿½åŠ ï¼‰ â”€â”€ */
function updateBackBtn(){
  const btn = document.getElementById("backBtn");
  if(!btn) return;
  const atEnding = (step >= DEPTH);
  btn.style.display = (step === 0 || atEnding) ? "none" : "block";
  btn.disabled = (step === 0);
}

function goBack(){
  // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‹ã‚‰ã®ã€Œæˆ»ã‚‹ã€ï¼šæœ€çµ‚æ‰‹å‰ã«æˆ»ã™
  if (step >= DEPTH){
    path.pop();              // æœ€å¾Œã®é¸æŠã‚’å–ã‚Šæ¶ˆã—
    step = DEPTH - 1;        // 4æ®µç›®ã¸
    const endControls = document.getElementById("endControls");
    if(endControls) endControls.innerHTML = "";
    imageWrap.innerHTML = "";
    sceneImg.style.display = "";   // å›ºå®šç”»åƒã‚’ï¼ˆã‚ã‚Œã°ï¼‰å†è¡¨ç¤º
    renderNext();
    updateBackBtn();
    return;
  }

  // é€šå¸¸ã®ã€Œæˆ»ã‚‹ã€ï¼šä¸€æ‰‹æˆ»ã™
  if (step > 0){
    path.pop();
    step--;
    if(step === 0 && introEl) introEl.style.display = ""; // å°å…¥æ–‡ã‚’æˆ»ã™
    sceneImg.style.display = ""; // ã‚·ãƒ¼ãƒ³ç”»åƒï¼ˆã‚ã‚Œã°ï¼‰ã‚’æˆ»ã™
    renderNext();
    updateBackBtn();
  }
}
/* â”€â”€ æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ï¼ˆã“ã“ã¾ã§è¿½åŠ ï¼‰ â”€â”€ */

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }

  /* ==== ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°é”æˆç‡ï¼ˆlocalStorageï¼‰â€” å¼·åŒ–ç‰ˆ ==== */
  (function(){
    const STORAGE_KEY = "shura_endings_v1";

    function loadVisited(){
      try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")); }
      catch { return new Set(); }
    }
    function saveVisited(set){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify([...set])); } catch {}
    }

    // 32é€šã‚Šã®ã‚­ãƒ¼ï¼ˆAAAAAã€œBBBBBï¼‰
    function allKeys(){
      const out = [];
      for(let i=0;i<32;i++){
        let s = "";
        for(let b=4;b>=0;b--) s += ((i>>b)&1) ? "B" : "A";
        out.push(s);
      }
      return out;
    }

    // æ˜Ÿãƒãƒ¼ï¼ˆâ˜…=é”æˆã€â˜†=æœªé”ï¼‰
    function starBar(done, total){
      const stars = "â˜…".repeat(done) + "â˜†".repeat(total - done);
      return stars.replace(/(.{4})/g, "$1 ");
    }

    window.__shuraVisited = loadVisited();

    window.__updateProgress = function(){
      const progressEl = document.getElementById("progress");
      if(!progressEl) return;

      const total = 32;
      const done  = window.__shuraVisited.size;
      const pct   = Math.floor((done/total)*100);

      progressEl.textContent = `é”æˆçŠ¶æ³ï¼š${done} / ${total}ï¼ˆ${pct}%ï¼‰`;

      let barEl = document.getElementById("progress_bar");
      if(!barEl){
        barEl = document.createElement("div");
        barEl.id = "progress_bar";
        barEl.className = "hint bar";
        progressEl.insertAdjacentElement("afterend", barEl);
      }
      barEl.textContent = starBar(done, total);

  // 100%ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¸€åº¦å‡ºã—ãŸã‚‰æ®‹ã™ï¼‰
if (done === total){
  // é€²æ—ãƒãƒ¼ã®ç›´å¾Œã«ä»•åˆ‡ã‚Šç·šã‚’1å›ã ã‘æŒ¿å…¥
  let sep = document.getElementById("progress_sep");
  if (!sep){
    sep = document.createElement("div");
    sep.id = "progress_sep";
    sep.style.height = "1px";
    sep.style.margin = "12px 0";
    sep.style.background = "linear-gradient(90deg,transparent, rgba(137,180,250,.35), transparent)";
    barEl.insertAdjacentElement("afterend", sep);
  }

  // æœ¬æ–‡ï¼šç™½ãï¼†å°‘ã—å¤§ããï¼ˆä¸­å¤®ãã‚ãˆã€æ—¢å­˜ã®é•·æ–‡ã¯ãã®ã¾ã¾ï¼‰
  let congrats = document.getElementById("congrats_all");
  if(!congrats){
    congrats = document.createElement("p");
    congrats.id = "congrats_all";
    // class="hint" ã¯è–„è‰²ã«ãªã‚‹ã®ã§ä»˜ã‘ã¾ã›ã‚“ï¼ˆä»˜ã‘ã¦ã‚‚ä¸‹ã® color æŒ‡å®šãŒå„ªå…ˆã•ã‚Œã¾ã™ï¼‰
    congrats.style.margin = "8px 0 0";
    congrats.style.textAlign = "center";
    congrats.style.color = "#fff";       // â˜… ç™½æ–‡å­—
    congrats.style.fontSize = "15px";    // â˜… å°‘ã—å¤§ãã‚ï¼ˆå¿…è¦ãªã‚‰18pxã«ï¼‰
    congrats.style.lineHeight = "1.9";

          congrats.innerHTML =
            "â€”â€” ã“ã‚Œã¯ä½™ãŒã‹ã¤ã¦é€šã£ãŸã€ã—ã‹ã—è¨˜æ†¶ã•ã‚Œãªã‹ã£ãŸå¹¾åƒã®æ—…ã®æ–­ç‰‡â€¦<br>"
          + "å½¢ã‚’å¤±ãã—ãŸæ¬ ç‰‡ã®ã²ã¨ã¤ã²ã¨ã¤ãŒæ‹¾ã‚ã‚Œ<br>"
          + "è›ã»ã©ã®ç¯ã‚’å–ã‚Šæˆ»ã—ãŸã‚ˆã†ã â€¦<br>"
          + "ç¤¼ã‚’è¨€ã†ãã€‚<br>"
          + "é–“ã‚‚ãªãå¤œãŒæ˜ã‘ã‚‹ã€æ–°ãŸãªæ—…è·¯ã‚’å¾€ãã¨ã—ã‚ˆã†ã€‚";
          barEl.insertAdjacentElement("afterend", congrats);
        }
      }
    };

    function renderUnseen(){
      const box = document.getElementById("unseen");
      if(!box) return;
      const keys = allKeys();
      const unseen = keys.filter(k => !window.__shuraVisited.has(k));
      box.innerHTML = (unseen.length === 0)
        ? "æœªé”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚32/32 å®Œèµ°ã§ã™ã€‚"
        : unseen.map(k => `<span class="key">${k}</span>`).join("");
    }

    document.addEventListener("DOMContentLoaded", function(){
      window.__updateProgress();
      renderUnseen();
    });

    window.__renderUnseen = renderUnseen;
    window.__saveVisited = function(){ saveVisited(window.__shuraVisited); };
  })();

  // åˆæœŸè¡¨ç¤ºæ™‚ã€BGMãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ•´ãˆã‚‹
(function boot(){
  function start(){
    try{
      updatePlayBtn && updatePlayBtn();
      updateBackBtn && updateBackBtn();
    }catch(e){ console.error(e); }
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", start, { once:true });
  } else {
    start();
  }
})();


/* GitHub Pagesç­‰ã§DOMContentLoadedãŒå…ˆã«èµ°ã£ã¦ã‚‚å®‰å…¨ã«ã™ã‚‹ã‚¬ãƒ¼ãƒ‰ */
(function(){
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initShuraSafe, { once:true });
  } else {
    // ã™ã§ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ãªã‚‰å³æ™‚
    initShuraSafe();
  }
  function initShuraSafe(){
    // ã“ã“ã¯ç©ºã§OKï¼šä¸‹ã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã§å†åº¦DOMContentLoadedã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
    // ãƒ–ãƒ©ã‚¦ã‚¶å·®ã§é †åºãŒå‰å¾Œã—ã¦ã‚‚2é‡å®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã† once:true ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§å•é¡Œãªã—ã€‚
  }
})();
</script>
</body>
</html>


