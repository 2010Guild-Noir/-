<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>修羅王丸と往く虚の仮想夜旅</title>

<link rel="icon" href="images/favicon.png" type="image/png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="images/favicon.svg" type="image/svg+xml">
<!-- 互換用にPNGも併記 -->
<link rel="icon" href="images/favicon-32.png" sizes="32x32" type="image/png">
<link rel="shortcut icon" href="favicon.ico">


<!-- Open Graph / Facebook / LINE / Slack など -->
<meta property="og:title" content="修羅王丸と往く虚の仮想夜旅">
<meta property="og:description" content="5つの選択で進む虚ろの森。どの道に正解も失敗もなく、あなたの歩みが夜をかたち作る。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://2010guild-noir.github.io/-/">
<meta property="og:image" content="https://2010guild-noir.github.io/-/images/og.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter（X） -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="修羅王丸と往く虚の仮想夜旅">
<meta name="twitter:description" content="5つの選択で進む虚ろの森。どの道に正解も失敗もなく、あなたの歩みが夜をかたち作る。">
<meta name="twitter:image" content="https://2010guild-noir.github.io/-/images/og.jpg">


<style>
  :root{
    --bg1:#0b1220;  /* 夜空の群青 */
    --bg2:#1b2735;  /* 森の藍 */
    --ink:#e9eef6;  /* 文字色 */
    --mute:#8aa0b5; /* サブ文字 */
    --accent:#89b4fa; /* アクセント */
  }
  html,body{
    margin:0; padding:0; height:100%;
    background: radial-gradient(1200px 800px at 50% -10%, var(--bg2), var(--bg1));
    color:var(--ink); font-family: "Shippori Mincho", "游明朝", "Yu Mincho", serif;
}
  .wrap{ max-width:900px; margin:0 auto; padding:24px 16px 56px; text-align:center; }
  h1{ margin:12px 0 6px; font-weight:700; font-size:clamp(20px, 3.6vw, 28px);}
  .sub{ color:var(--mute); margin:0 0 18px; font-size:14px;}
  .scene{
    width:min(92vw,880px); aspect-ratio: 16/9; object-fit: cover;
    border-radius:16px; box-shadow: 0 8px 28px rgba(0,0,0,.35); display:block; margin:8px auto 14px;
  }
  .panel{
    background: rgba(10,16,26,.45); backdrop-filter: blur(6px);
    border: 1px solid rgba(137,180,250,.18);
    border-radius: 16px; padding:18px 16px; margin:0 auto 14px; max-width:880px;
    box-shadow: 0 6px 24px rgba(0,0,0,.25);
    text-align:left;
  }
  .panel p{ margin: 0.4em 0; line-height:1.95; }
  .narr{ white-space:pre-wrap; }
  #micro{ margin: 2px 0 10px; color:#cfdbeb; }
  #text{ font-size:clamp(16px, 2.6vw, 20px); margin:0 0 10px; text-align:center;}
  .choices{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:12px 0 0;}
  button{
    background: transparent; color:var(--ink);
    border:1px solid var(--accent); border-radius:999px;
    padding:10px 18px; font-size:16px; cursor:pointer;
    transition:.15s transform ease, .15s background-color ease, .15s border-color ease;
  }
  button:hover{ transform: translateY(-1px); background: rgba(137,180,250,.08);}
  #story{ margin:16px 0 0; font-weight:600; min-height:2.6em; text-align:center;}
  #imageWrap img{ max-width:min(92vw,880px); height:auto; display:block; margin:14px auto 0; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.35);}
  .hint{ color:#8aa0b5; font-size:13px; margin-top:10px; text-align:center; }
  hr{ border:0; height:1px; background: linear-gradient(90deg,transparent, rgba(137,180,250,.35), transparent); margin:26px 0; }

  /* 進捗UI */
  .key{
    display:inline-block; margin:2px 4px; padding:2px 6px;
    border:1px solid rgba(137,180,250,.35); border-radius:8px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px; color:#cfe1ff;
  }
  .bar{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; letter-spacing:1px; }

  /* BGM */
  .audioBar{ display:flex; align-items:center; justify-content:center; gap:10px; margin:10px auto 6px; opacity:.9; }
  .audioBar button{ border-radius:10px; padding:8px 12px; font-size:14px; }
  .audioBar input[type="range"]{ width:180px; }
  .badge{ display:inline-block; font-size:12px; color:#cfe1ff; border:1px dashed rgba(207,225,255,.5); padding:2px 8px; border-radius:8px; }
  .footnote{ color:var(--mute); font-size:12px; margin-top:8px; text-align:center;}

/* 右下の「戻る」ボタン */
#backBtn{
  position: fixed;
  right: 12px; bottom: 12px;
  font-size: 12px; line-height: 1;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(137,180,250,.35);
  background: rgba(10,16,26,.45);
  color: #cfe1ff;
  opacity: .55;
  backdrop-filter: blur(6px);
  box-shadow: 0 4px 14px rgba(0,0,0,.25);
  cursor: pointer;
  z-index: 50;
}
#backBtn:hover{ opacity: .85; transform: translateY(-1px); }
#backBtn:disabled{ opacity: .25; cursor: default; transform:none; }

</style>
</head>
<body>
<div class="wrap">
  <h1>修羅王丸と往く虚の仮想夜旅</h1>
  <p class="sub">5つの選択が虚ろの森に道を引く。どの道に正解も失敗もなく、ただ誰のものとも違う、あなた自身の旅となる。</p>

  <!-- 固定の選択画面画像（任意）。無ければ自動で非表示。 -->
  <img id="scene" class="scene" src="images/scene_select.webp" alt="夜の森" />

  <!-- ショートストーリー（冒頭） -->
 <div id="intro" class="panel">
  <p class="narr">しんしんと、音もなく夜が降る。</p>
  <p class="narr">あなたは寝床に身を伸ばし、ただ目を閉じていた。</p>
  <p class="narr">その無音に、ひとすじの声が差し込む。</p>
  <p class="narr">「其方、虚ろの夜を渡る気か」</p>
  <p class="narr">闇を纏った修羅王丸が 赤い瞳でこちらを見つめている。</p>
  <p class="narr">気づけば、あなたは黒い森の縁に立っていた。</p>
  <p class="narr">「ならば、余が導こう。ただしこれは夢ではない。仮想にして、真の旅よ」</p>
</div>

  <!-- 選択パネル -->
  <div class="panel">
    <p id="micro" class="narr"></p>
    <p id="text" style="text-align:center;">夜の森で、修羅王丸が手招く。あなたは歩を合わせる？</p>
    <div id="choices" class="choices" style="text-align:center;">
      <button onclick="choose(1)">歩を合わせる</button>
      <button onclick="choose(2)">距離を取る</button>
    </div>
    <p id="story"></p>
  </div>

  <div id="imageWrap"></div>
  <div id="endControls" style="text-align:center; margin-top:10px;"></div>

  <p class="hint" id="hint"></p>
  <p class="hint" id="progress"></p>
  <details id="comp" class="hint" style="margin-top:6px;">
    <summary>未達エンディング一覧を開く</summary>
    <div id="unseen" class="hint" style="margin-top:8px;"></div>
  </details>


  <!-- ===== BGM（ページ最下部） ===== -->
  <div class="panel" style="text-align:center; margin-top:24px;">
    <p class="narr" style="text-align:center; color:#cfdbeb; margin-bottom:10px;">夜歩きの支度：音が邪魔ならミュートを。小さく流すのも一興だ。</p>
    <audio id="bgm" src="audio/bgm_night_forest.mp3" loop preload="auto"></audio>
    <div class="audioBar">
      <span class="badge">BGM</span>
      <button id="playBtn" onclick="togglePlay()">▶ 再生</button>
      <button onclick="bgm.muted = !bgm.muted; this.textContent = bgm.muted ? '🔇 ミュート解除' : '🔊 ミュート';">🔊 ミュート</button>
      <label>音量 <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35" oninput="bgm.volume=this.value"></label>
    </div>
    <p class="footnote">※ 自動再生制限により、最初のクリックまで音は鳴りません。</p>
  </div>
</div>
<!-- ▼ ここに戻るボタンを追加 ▼ -->
  <button id="backBtn" onclick="goBack()" title="一手戻る">← 戻る</button>
  <!-- ▲ 追加ここまで ▲ -->
<script>
  /* ===== 基本設定 ===== */
  const DEPTH = 5;            // 5段階 = 32エンド
  let step = 0;               // 現在段階（0スタート）
  let path = [];              // 選択の記録 [1,2,1,2,1]
  const introEl  = document.getElementById("intro");
  const microEl  = document.getElementById("micro");
  const textEl   = document.getElementById("text");
  const storyEl  = document.getElementById("story");
  const choicesEl= document.getElementById("choices");
  const hintEl   = document.getElementById("hint");
  const imageWrap= document.getElementById("imageWrap");
  const sceneImg = document.getElementById("scene");
  sceneImg.onerror = ()=>{ sceneImg.style.display = "none"; };

  // BGM
  const bgm = document.getElementById("bgm");
  const playBtn = document.getElementById("playBtn");
  bgm.volume = 0.35;
  let audioArmed = false;
  function armAudio(){ if(!audioArmed){ audioArmed = true; bgm.play().catch(()=>{}); updatePlayBtn(); } }
  function togglePlay(){ if(bgm.paused){ bgm.play().catch(()=>{}); } else { bgm.pause(); } updatePlayBtn(); }
  function updatePlayBtn(){ playBtn.textContent = bgm.paused ? "▶ 再生" : "⏸ 一時停止"; }
  document.addEventListener("click", armAudio, { once:true });
  bgm.addEventListener("play", updatePlayBtn);
  bgm.addEventListener("pause", updatePlayBtn);

  /* ===== 各段ショートストーリー ===== */
  function getNarr(step, prefix){
 const N = {
  2: {
    "A":
`落ち葉がやわらかく鳴る。あなたが一歩進むたび、足音は夜に吸われる。
「足を合わせる必要はない。呼吸を合わせよ。静けさは味方だ」`,
    "B":
`少し離れると、森の輪郭が広く見える。距離は安心にも迷いにもなる。
「離れるのは良い。ただし見失うほど遠ざかるな。自分の歩幅を忘れるな」`
  },
  3: {
    "AA":
`木立の奥に小さな祠。戸は古く、押せば開きそうだ。
「扉は語らぬ。開けば沈黙で答える。入るか、留めるか、選べ」`,
    "AB":
`草むらで露が揺れ、金属のような澄んだ音がかすかに響く。
「触れて確かめるも、そっと見送るも、どちらも静けさの作法だ」`,
    "BA":
`細い川が道を横切る。流れは浅いが、足を濡らせば冷たい。
「渡るは決意、渡らぬは見極め。どちらも術だ。己に合う方を取れ」`,
    "BB":
`獣道が左右に分かれる。どちらにも踏み跡はあるが、先は見えない。
「地図はない。あるのは其方の判断だけ。決めよ」`
  },
  4: {
    "AAA":
`祠の奥に灯が一つ、弱く揺れる。息を吹きかければ強まりも消えもする。
「灯を扱え。灯に振り回されるな。ともすか、消すか」`,
    "AAB":
`名を呼んだ余韻がまだ残る。もう一度呼べば、さらに深く届くだろう。
「二度目は情でなく技で呼べ。呼ぶか、止めるか」`,
    "ABA":
`握った手の温度が現へ引き戻す。強く握れば確か、離せば歩きやすい。
「握るは支え、離すは委ね。どちらを選ぶ」`,
    "ABB":
`背中に残る温もりが薄れていく。振り返れば拾えるが、歩は止まる。
「回収するか、前へ譲るか。別れの礼法を選べ」`,
    "BAA":
`川幅は狭い。浅瀬に平たい石が点々と続く。足を入れれば速いが冷たい。
「濡れる速さか、確かな足場か。其方はどちらを試す？」`,
    "BAB":
`橋はないが声は渡る。短い言葉なら、流れに呑まれず届く。
「声をかけるか、黙ってうなずくか。どちらも意思だ」`,
    "BBA":
`左の道は湿って滑りやすいが、草が柔らかい。右は乾いて速いが、石が尖る。
「遅く慎重にか、速く軽やかにか。今の其方に正しい方を選べ」`,
    "BBB":
`前は行き止まりに見える。だが空は開き、地面には細い段差が続く。
「名を変えれば道になる。空を見るか、足元を見るか。選べ」`
  }
};


    // 2〜4段目：最長一致で返す
    const m = N[step];
    if (m){
      let key = prefix || "";
      while(key.length >= 0){
        if(m[key]) return m[key];
        key = key.slice(0,-1);
        if(key.length===0) break;
      }
    }

    // 5段目：修羅王丸の一言（最終の前口上）
   if (step === 5){
  const last2 = (prefix || "").slice(-2);
  const narrMap = {
    "AA": "「近さは力にも刃にもなる。最後の一手、落ち着いて選べ」",
    "AB": "「間合いは整った。崩すも守るも、ここで決めよ」",
    "BA": "「音は細り、道は痩せた。渡りきるか、留まるか。どちらも正だ」",
    "BB": "「風が開けた。仰ぐ空と踏む地、今の其方はどちらを見る」"
  };
  return narrMap[last2] || "「森は息を潜めた。其方の一手で旅を締めよ」";
}


    return "";
  }

  /* ===== 中間ノード（問いとボタン文） ===== */
  function getNode(step, prefix){
    const T = {
  1: {
    "": { q:"夜の森で、修羅王丸が手招く。あなたは歩を合わせる？",
          a:"歩を合わせる", b:"距離を取る" }
  },
  2: {
    "A": { q:"呼吸を整えながら進む。次はどうする？",
           a:"名を呼ぶ", b:"黙って並ぶ" },
    "B": { q:"距離を保ったまま進む。次はどうする？",
           a:"追いつく", b:"さらに離れる" }
  },
  3: {
    "AA":{ q:"小さな祠の前。どうする？",
           a:"扉を押し開ける", b:"手を置いて気配を読む" },
    "AB":{ q:"露の音が鳴る草むら。どうする？",
           a:"手を伸ばして確かめる", b:"手を引いて見守る" },
    "BA":{ q:"浅い流れが道を断つ。どうする？",
           a:"渡る", b:"渡らない" },
    "BB":{ q:"分かれ道。どちらへ？",
           a:"左へ進む", b:"右へ進む" }
  },
  4: {
    "AAA":{ q:"弱い灯。どう扱う？",
            a:"灯をともす", b:"灯を消す" },
    "AAB":{ q:"名の余韻。どうする？",
            a:"もう一度呼ぶ", b:"呼ぶのをやめる" },
    "ABA":{ q:"手のぬくもり。どうする？",
            a:"手を握る", b:"手を離す" },
    "ABB":{ q:"背の温度が薄れる。どうする？",
            a:"振り返る", b:"そのまま歩く" },
    "BAA":{ q:"浅瀬と飛び石。どう進む？",
            a:"水を踏んで速く進む", b:"石を選んで確かに進む" },
    "BAB":{ q:"声は届く距離。どうする？",
            a:"声をかける", b:"黙ってうなずく" },
    "BBA":{ q:"湿りの道と乾きの道。どちらへ？",
            a:"湿った道", b:"乾いた道" },
    "BBB":{ q:"行き止まりに見える前方。どうする？",
            a:"空を仰ぐ", b:"足元を見る" }
  }
};


    // 1〜4段目：最長一致
    if (step >= 1 && step <= 4) {
      const s = T[step]; if (!s) return { q:"森は静かにあなたを待つ。どうする？", a:"進む", b:"留まる" };
      let key = prefix || "";
      while (key.length >= 0) {
        if (s[key]) return s[key];
        key = key.slice(0, -1);
        if (key.length === 0 && s[""]) return s[""];
        if (key.length === 0) break;
      }
      return { q:"森は静かにあなたを待つ。どうする？", a:"進む", b:"留まる" };
    }

    // 5段目は動的に生成（prefix は4文字＝直前までの経路）
    if (step === 5) {
      const last2 = (prefix || "").slice(-2); // "AA","AB","BA","BB"
      const map = {
        "AA": { q:"最奥。灯と影が寄り添う。あなたの最後の選択は？",
                a:"そばに寄る", b:"身を退く" },
        "AB": { q:"朝と夜の静かな間合いが凪ぐ。あなたの最後の選択は？",
                a:"暁を目指す", b:"森へ引き返す" },
        "BA": { q:"最奥。川音が細り道が痩せる。あなたの最後の選択は？",
                a:"渡りきる", b:"岸に留まる" },
        "BB": { q:"最奥。風が開ける。あなたの最後の選択は？",
                a:"空を仰ぐ", b:"地を踏みしめる" }
      };
      return map[last2] || { q:"最奥。森は息を潜める。あなたは？", a:"進み出る", b:"立ち止まる" };
    }

    return { q:"森は静かにあなたを待つ。どうする？", a:"進む", b:"留まる" };
  }


/* ===== エンディング文生成 ===== */
function composeEnding(key){
  const Acount = [...key].filter(c => c === "A").length;     // Aの数（0..5）
  const last   = key[key.length - 1];                        // 最後の手 A/B
  const first2 = key.slice(0,2);                             // 冒頭傾向
  const last2  = key.slice(-2);                              // 終盤傾向

  // 経路キーを 0..31 の整数に（A=0, B=1 の2進数）
  const pathNum = parseInt(key.replace(/A/g, '0').replace(/B/g, '1'), 2);
  const pick5 = n => ((n % 5) + 5) % 5;                      // 安全な mod 5
  const idx = pick5(pathNum);

  // 冒頭情景（前半2手で決定）
  const motif1 = ({
    "AA": "月明かりが二人の影を静かに落とし、",
    "AB": "露が風に震え、草むらの鈴が遠くで鳴り、",
    "BA": "川音が細くなり、浅い波紋が靴先を撫で、",
    "BB": "枝葉の隙間から星がこぼれ、"
  })[first2] || "夜が深さを増し、";

  // 終盤情景（終盤2手で決定）
  const motif2 = ({
    "AA": "祠の灯が息のように明滅し、",
    "AB": "間合いは凪いで静けさが深まり、",
    "BA": "岸の匂いが近づいて道は痩せ、",
    "BB": "風は道を開き地は確かさを返し、"
  })[last2] || "森は息を潜め、";

  // 最後の一歩（直近のA/Bで決定）
  const hinge = (last === "A")
    ? "最後の一歩は其方が先に踏み出し、"
    : "最後の一歩は余が先に踏み、其方は境の手前に立ち、";

  // 本文締め（A多/B多 それぞれ5種）
  const farewellA = [
    "だからこそ其方の歩みは尊い。",
    "その想いは受け取った。",
    "この先は、其方は其方の速さで行け。",
    "その選択を余は嬉しく思う。",
    "この先は名残は残るが、道は別だ。"
  ];
  const farewellB = [
    "よく歩いたな。",
    "ここからは其方の道だ。",
    "旅の続きを贈ろう。",
    "先の道は二つに分かれた。",
    "振り返らず進め。"
  ];
  const isAheavy = (Acount >= 3);
  const farewellBody = (isAheavy ? farewellA : farewellB)[idx];

  // ★ 修羅王丸の最後の一言は削除（ここがなくなっています）
  return `${motif1}${motif2}${hinge}${farewellBody}`;
}

  /* ===== 進行ロジック ===== */
  function pathToKey(arr){ return arr.map(n => n===1 ? "A" : "B").join(""); }

  function renderNext(){
    const prefix   = pathToKey(path);
    const nextStep = step + 1;

    // 2段目以降の前口上（5段目も含む）
    microEl.innerText = (nextStep >= 2) ? getNarr(nextStep, prefix) : "";

    const node = getNode(nextStep, prefix);

    textEl.innerText = node.q;
    storyEl.innerText = "";
    imageWrap.innerHTML = "";
    hintEl.innerText = `選択 ${step}/${DEPTH}（経路: ${prefix || "—"}）`;

    choicesEl.innerHTML =
      `<button onclick="choose(1)">${escapeHtml(node.a)}</button>` +
      `<button onclick="choose(2)">${escapeHtml(node.b)}</button>`;
  // ▼ ここを追加
  updateBackBtn();
  // ▲ ここまで
}

  function choose(option){
    armAudio();
    if(step === 0 && introEl) introEl.style.display = "none";

    path.push(option);
    step++;

    if(step < DEPTH){
      renderNext();
      return;
    }

    // エンディング
    const key = pathToKey(path);
    const text = composeEnding(key);

    // 達成率：記録＆更新
    window.__shuraVisited.add(key);
    if(window.__saveVisited) window.__saveVisited();
    if(window.__updateProgress) window.__updateProgress();
    if(window.__renderUnseen) window.__renderUnseen();

    microEl.innerText = "";
    textEl.innerText = "【旅の結末】（" + key + "）";
    storyEl.innerText = text;

    // パネル内は空にし、画像の下にコントロールを出す
    hintEl.innerText ="";
    choicesEl.innerHTML = "";

    renderEndingImage(key);
    const endControls = document.getElementById("endControls");
    endControls.innerHTML =
      '<button onclick="restart()">最初から</button>' +
      '<p class="hint" style="margin-top:8px;">もう一度遊ぶには「最初から」を押してください。</p>';

    sceneImg.style.display = "none";
// ▼ ここを追加（エンディング時は戻るボタンを隠す）
    updateBackBtn();
    // ▲ ここまで
  }

  function renderEndingImage(key){
    const imgPath = "images/ending_" + key + ".webp";
    const img = new Image();
    img.alt = "Ending " + key;
    img.onload = ()=>{ imageWrap.innerHTML=""; imageWrap.appendChild(img); };
    img.onerror = ()=>{ imageWrap.innerHTML=""; };
    img.src = imgPath;
  }

  function restart(){
    step = 0; path = [];
    if(introEl) introEl.style.display = "";
    microEl.innerText = "";
    textEl.innerText = "夜の森で、修羅王丸が手招く。あなたは歩を合わせる？";
    storyEl.innerText = ""; hintEl.innerText = "";
    choicesEl.innerHTML =
      '<button onclick="choose(1)">歩を合わせる</button>' +
      '<button onclick="choose(2)">距離を取る</button>';
    imageWrap.innerHTML = "";
    sceneImg.style.display = "";
    document.getElementById("endControls").innerHTML = "";
// ▼ ここを追加
  updateBackBtn();
  // ▲ ここまで
  }

/* ── 戻るボタンの制御（ここから追加） ── */
function updateBackBtn(){
  const btn = document.getElementById("backBtn");
  if(!btn) return;
  const atEnding = (step >= DEPTH);
  btn.style.display = (step === 0 || atEnding) ? "none" : "block";
  btn.disabled = (step === 0);
}

function goBack(){
  // エンディングからの「戻る」：最終手前に戻す
  if (step >= DEPTH){
    path.pop();              // 最後の選択を取り消し
    step = DEPTH - 1;        // 4段目へ
    const endControls = document.getElementById("endControls");
    if(endControls) endControls.innerHTML = "";
    imageWrap.innerHTML = "";
    sceneImg.style.display = "";   // 固定画像を（あれば）再表示
    renderNext();
    updateBackBtn();
    return;
  }

  // 通常の「戻る」：一手戻す
  if (step > 0){
    path.pop();
    step--;
    if(step === 0 && introEl) introEl.style.display = ""; // 導入文を戻す
    sceneImg.style.display = ""; // シーン画像（あれば）を戻す
    renderNext();
    updateBackBtn();
  }
}
/* ── 戻るボタンの制御（ここまで追加） ── */

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[s]));
  }

  /* ==== エンディング達成率（localStorage）— 強化版 ==== */
  (function(){
    const STORAGE_KEY = "shura_endings_v1";

    function loadVisited(){
      try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")); }
      catch { return new Set(); }
    }
    function saveVisited(set){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify([...set])); } catch {}
    }

    // 32通りのキー（AAAAA〜BBBBB）
    function allKeys(){
      const out = [];
      for(let i=0;i<32;i++){
        let s = "";
        for(let b=4;b>=0;b--) s += ((i>>b)&1) ? "B" : "A";
        out.push(s);
      }
      return out;
    }

    // 星バー（★=達成、☆=未達）
    function starBar(done, total){
      const stars = "★".repeat(done) + "☆".repeat(total - done);
      return stars.replace(/(.{4})/g, "$1 ");
    }

    window.__shuraVisited = loadVisited();

    window.__updateProgress = function(){
      const progressEl = document.getElementById("progress");
      if(!progressEl) return;

      const total = 32;
      const done  = window.__shuraVisited.size;
      const pct   = Math.floor((done/total)*100);

      progressEl.textContent = `達成状況：${done} / ${total}（${pct}%）`;

      let barEl = document.getElementById("progress_bar");
      if(!barEl){
        barEl = document.createElement("div");
        barEl.id = "progress_bar";
        barEl.className = "hint bar";
        progressEl.insertAdjacentElement("afterend", barEl);
      }
      barEl.textContent = starBar(done, total);

  // 100%メッセージ（一度出したら残す）
if (done === total){
  // 進捗バーの直後に仕切り線を1回だけ挿入
  let sep = document.getElementById("progress_sep");
  if (!sep){
    sep = document.createElement("div");
    sep.id = "progress_sep";
    sep.style.height = "1px";
    sep.style.margin = "12px 0";
    sep.style.background = "linear-gradient(90deg,transparent, rgba(137,180,250,.35), transparent)";
    barEl.insertAdjacentElement("afterend", sep);
  }

  // 本文：白く＆少し大きく（中央ぞろえ、既存の長文はそのまま）
  let congrats = document.getElementById("congrats_all");
  if(!congrats){
    congrats = document.createElement("p");
    congrats.id = "congrats_all";
    // class="hint" は薄色になるので付けません（付けても下の color 指定が優先されます）
    congrats.style.margin = "8px 0 0";
    congrats.style.textAlign = "center";
    congrats.style.color = "#fff";       // ★ 白文字
    congrats.style.fontSize = "15px";    // ★ 少し大きめ（必要なら18pxに）
    congrats.style.lineHeight = "1.9";

          congrats.innerHTML =
            "—— これは余がかつて通った、しかし記憶されなかった幾千の旅の断片…<br>"
          + "形を失くした欠片のひとつひとつが拾われ<br>"
          + "蛍ほどの灯を取り戻したようだ…<br>"
          + "礼を言うぞ。<br>"
          + "間もなく夜が明ける、新たな旅路を往くとしよう。";
          barEl.insertAdjacentElement("afterend", congrats);
        }
      }
    };

    function renderUnseen(){
      const box = document.getElementById("unseen");
      if(!box) return;
      const keys = allKeys();
      const unseen = keys.filter(k => !window.__shuraVisited.has(k));
      box.innerHTML = (unseen.length === 0)
        ? "未達はありません。32/32 完走です。"
        : unseen.map(k => `<span class="key">${k}</span>`).join("");
    }

    document.addEventListener("DOMContentLoaded", function(){
      window.__updateProgress();
      renderUnseen();
    });

    window.__renderUnseen = renderUnseen;
    window.__saveVisited = function(){ saveVisited(window.__shuraVisited); };
  })();

  // 初期表示時、BGMボタンの表示を整える
(function boot(){
  function start(){
    try{
      updatePlayBtn && updatePlayBtn();
      updateBackBtn && updateBackBtn();
    }catch(e){ console.error(e); }
  }
  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", start, { once:true });
  } else {
    start();
  }
})();


/* GitHub Pages等でDOMContentLoadedが先に走っても安全にするガード */
(function(){
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initShuraSafe, { once:true });
  } else {
    // すでに読み込み済みなら即時
    initShuraSafe();
  }
  function initShuraSafe(){
    // ここは空でOK：下の既存コードで再度DOMContentLoadedを使っています。
    // ブラウザ差で順序が前後しても2重実行されないよう once:true を使っているので問題なし。
  }
})();
</script>
</body>
</html>


